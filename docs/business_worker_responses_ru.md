# Руководство: отклики бизнес-исполнителей

Это руководство описывает новую логику работы с бизнес-исполнителями (business workers), флагом `can_respond` и автоматическим подставлением бизнес-аккаунта при откликах.

## Что изменилось
- В таблице `business_workers` появилось поле `can_respond` (булево, по умолчанию `false`). Если флаг выключен, бизнес-исполнитель не может отправлять отклики.
- При создании или обновлении рабочего владелец бизнес-аккаунта может явно разрешить/запретить отклики через поле `can_respond`.
- Когда бизнес-исполнитель с ролью `business_worker` отправляет или отменяет отклик, система автоматически находит связанный бизнес-аккаунт и подставляет его `business_user_id` вместо `worker_user_id`. Так переписка и подтверждения идут от имени владельца бизнеса.

## Настройка бизнес-исполнителя
### Создание
`POST /business/workers` (требуется аутентификация владельца бизнеса). Тело запроса:
```json
{
  "login": "worker.login",
  "name": "Имя",
  "surname": "Фамилия",
  "phone": "+79991234567",
  "password": "Пароль",
  "can_respond": true
}
```
- `can_respond` необязателен; если не передать, будет `false`.
- При создании автоматически заводится пользователь с ролью `business_worker` и приватный чат с владельцем.

Ответ `201 Created`:
```json
{
  "worker": {
    "id": 10,
    "business_user_id": 5,
    "worker_user_id": 42,
    "login": "worker.login",
    "status": "active",
    "can_respond": true,
    "user": {
      "id": 42,
      "name": "Имя",
      "surname": "Фамилия",
      "phone": "+79991234567"
    }
  }
}
```

### Обновление прав на отклики
`PUT /business/workers/:id` (владелец бизнеса). Тело запроса можно передавать частично:
```json
{
  "can_respond": false,
  "status": "active"
}
```
- При `can_respond: false` бизнес-исполнитель больше не сможет откликаться.
- Остальные поля (`login`, `name`, `surname`, `phone`, `password`, `status`) работают как раньше.

### Просмотр
`GET /business/workers` возвращает список работников с текущим флагом `can_respond`.

## Отправка откликов от имени бизнеса
Бизнес-исполнитель использует свой токен (роль `business_worker`). Backend сам:
1. Проверяет, что у работника `can_respond = true`.
2. Находит его `business_user_id` и сохраняет отклик от имени бизнес-аккаунта.
3. Создаёт/использует чаты и подтверждения с учётом бизнес-владельца.

### Формат отклика
Ниже примеры для разных типов объявлений. Общие правила:
- Тело запроса включает идентификатор объявления и условия сделки.
- `user_id` в теле передавать не нужно — он берётся из контекста токена.
- При успешном отклике приходит созданный объект с полями чата и участников.

#### Отклик на услугу (Ad)
`POST /ad_responses`
```json
{
  "ad_id": 123,
  "price": 1500,
  "description": "Готов выполнить за день"
}
```
#### Отклик на аренду (Rent)
`POST /rent_responses`
```json
{
  "rent_id": 77,
  "price": 2500,
  "description": "Свободен завтра"
}
```
#### Отклик на объявление об аренде (Rent Ad)
`POST /rent_ad_responses`
```json
{
  "rent_ad_id": 88,
  "price": 1800,
  "description": "Есть опыт в этой нише"
}
```
#### Отклик на заказ/работу (Work Ad)
`POST /work_ad_responses`
```json
{
  "work_ad_id": 91,
  "price": 3200,
  "description": "Выполню под ключ"
}
```

### Отмена отклика
`DELETE /{тип}_responses/:id` с токеном бизнес-исполнителя.
- Маршруты соответствуют созданию: `/ad_responses/:id`, `/rent_responses/:id`, `/rent_ad_responses/:id`, `/work_ad_responses/:id`.
- При отмене используется тот же поиск бизнес-аккаунта; если работнику запрещено отвечать или он не связан с бизнесом, вернётся `403 Forbidden`.

## Ошибки и ограничения
- `403 Forbidden`: у работника выключен `can_respond` или он не привязан к бизнес-аккаунту.
- `409/400`: занятый логин или неверные данные при создании/обновлении работника.
- Ограничения подписки на отклики сохраняются: если превышен лимит по тарифу, вернётся ошибка баланса.

## Что нужно передавать в запросах
- **Авторизация**: Bearer-токен. Для действий владельца — токен пользователя с ролью `business`. Для откликов от имени исполнителя — токен пользователя с ролью `business_worker`.
- **Тело**: JSON, как в примерах выше. Дополнительные поля (`user_id`, `business_user_id`) сервер проставляет сам.

Эти правила позволяют владельцу бизнеса контролировать, кто из работников может откликаться, и гарантируют, что отклики и чаты ведутся от имени бизнес-аккаунта.
